name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  KUBERNETES_VERSION: "1.31.0"

jobs:
  # ============================================
  # YAML & Kustomize Validation
  # ============================================
  validate:
    name: Validate Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flux CLI
        uses: fluxcd/flux2/action@main

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Setup kubeconform
        uses: bmuschko/setup-kubeconform@v1

      - name: Validate YAML syntax
        run: |
          echo "ðŸ” Checking YAML syntax with yamllint..."
          pip install yamllint -q --break-system-packages

          # Create yamllint config for Kubernetes
          cat > .yamllint.yml << 'EOF'
          extends: relaxed
          rules:
            line-length: disable
            truthy:
              check-keys: false
            document-start: disable
            comments: disable
          EOF

          yamllint -c .yamllint.yml \
            --no-warnings \
            -f parsable \
            apps/ clusters/ infrastructure/ 2>&1 | head -20 || true

          echo "âœ… YAML syntax check complete"

      - name: Validate Kustomize builds
        run: |
          echo "ðŸ” Validating Kustomize overlays..."
          for dir in clusters/*/; do
            echo "  â†’ Building $dir"
            kustomize build "$dir" > /dev/null || exit 1
          done
          echo "âœ… All Kustomize builds successful"

      - name: Validate Kubernetes manifests
        run: |
          echo "ðŸ” Validating Kubernetes manifests with kubeconform..."
          for dir in clusters/*/; do
            echo "  â†’ Validating $dir"
            kustomize build "$dir" | kubeconform \
              -strict \
              -summary \
              -kubernetes-version ${{ env.KUBERNETES_VERSION }} \
              -ignore-missing-schemas \
              -skip CustomResourceDefinition,Kustomization,GitRepository,OCIRepository,HelmRepository,HelmRelease,HelmChart,ExternalSecret,ClusterSecretStore,SecretStore,Issuer,ClusterIssuer,Certificate,CiliumNetworkPolicy,CiliumClusterwideNetworkPolicy,ScaledObject
          done

      - name: Validate Flux CRDs
        run: |
          echo "ðŸ” Validating Flux custom resources..."
          flux check --pre || true

          # Validate HelmReleases
          find . -name "helm-release.yaml" -o -name "helmrelease.yaml" | while read file; do
            echo "  â†’ Checking $file"
            yq e '.spec.chart.spec.version' "$file" > /dev/null 2>&1 || echo "    âš ï¸  No version pinned in $file"
          done

  # ============================================
  # Security Scanning
  # ============================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan for secrets
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for 'latest' tags
        run: |
          echo "ðŸ” Checking for 'latest' image tags..."
          LATEST_FOUND=0

          grep -rn "image:.*:latest" --include="*.yaml" --include="*.yml" . 2>/dev/null | grep -v ".git" | while read line; do
            echo "âŒ Found 'latest' tag: $line"
            LATEST_FOUND=1
          done

          grep -rn "tag: latest" --include="*.yaml" --include="*.yml" . 2>/dev/null | grep -v ".git" | while read line; do
            echo "âŒ Found 'latest' tag: $line"
            LATEST_FOUND=1
          done

          if [ $LATEST_FOUND -eq 1 ]; then
            echo ""
            echo "âš ï¸  Warning: 'latest' tags found. Consider pinning to specific versions."
          else
            echo "âœ… No 'latest' tags found"
          fi

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      - name: Run kube-linter
        uses: stackrox/kube-linter-action@v1
        with:
          directory: .
          config: .kube-linter.yaml
        continue-on-error: true

  # ============================================
  # SOPS Secrets Validation
  # ============================================
  secrets:
    name: Validate Secrets
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SOPS
        uses: mdgreenwald/mozilla-sops-action@v1.6.0

      - name: Check SOPS files are encrypted
        run: |
          echo "ðŸ” Checking SOPS encrypted files..."
          find . -name "*.sops.yaml" -o -name "*.sops.yml" | while read file; do
            echo "  â†’ Checking $file"
            # Verify file contains sops metadata (is encrypted)
            if ! grep -q "sops:" "$file"; then
              echo "âŒ File appears unencrypted: $file"
              exit 1
            fi
            # Check for accidental plaintext secrets
            if grep -qE "(password|secret|token|key):\s*['\"]?[^$]" "$file" 2>/dev/null; then
              if ! grep -q "ENC\[AES256_GCM" "$file"; then
                echo "âš ï¸  Potential plaintext secret in: $file"
              fi
            fi
          done
          echo "âœ… All SOPS files appear encrypted"

      - name: Validate SOPS decryption
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
        run: |
          if [ -z "$SOPS_AGE_KEY" ]; then
            echo "âš ï¸  SOPS_AGE_KEY not set, skipping decryption test"
            exit 0
          fi

          echo "ðŸ” Testing SOPS decryption..."
          find . -name "*.sops.yaml" -o -name "*.sops.yml" | while read file; do
            echo "  â†’ Decrypting $file"
            sops -d "$file" > /dev/null || {
              echo "âŒ Failed to decrypt: $file"
              exit 1
            }
          done
          echo "âœ… All secrets decrypt successfully"

  # ============================================
  # Kubernetes Best Practices
  # ============================================
  best-practices:
    name: Best Practices
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Check for missing resource limits
        run: |
          echo "ðŸ” Checking for resource limits..."
          MISSING=0

          find apps/ -name "deployment.yaml" | while read file; do
            if ! grep -q "resources:" "$file"; then
              echo "âš ï¸  Missing resources in: $file"
              MISSING=1
            fi
            if ! grep -q "limits:" "$file"; then
              echo "âš ï¸  Missing limits in: $file"
            fi
          done

      - name: Check for missing health probes
        run: |
          echo "ðŸ” Checking for health probes..."

          find apps/ -name "deployment.yaml" | while read file; do
            HAS_LIVENESS=$(grep -c "livenessProbe:" "$file" 2>/dev/null || echo 0)
            HAS_READINESS=$(grep -c "readinessProbe:" "$file" 2>/dev/null || echo 0)

            if [ "$HAS_LIVENESS" -eq 0 ] && [ "$HAS_READINESS" -eq 0 ]; then
              echo "âš ï¸  No probes in: $file"
            fi
          done

      - name: Check for security contexts
        run: |
          echo "ðŸ” Checking for security contexts..."

          find apps/ -name "deployment.yaml" | while read file; do
            if ! grep -q "securityContext:" "$file"; then
              echo "âš ï¸  Missing securityContext in: $file"
            fi
            if grep -q "privileged: true" "$file"; then
              echo "âŒ Privileged container in: $file"
            fi
          done

      - name: Check image tags are pinned
        run: |
          echo "ðŸ” Checking image tag pinning..."

          find apps/ infrastructure/ -name "*.yaml" | xargs grep -h "image:" 2>/dev/null | while read line; do
            # Check for :latest or no tag
            if echo "$line" | grep -qE "image:\s+[^:]+\s*$|:latest"; then
              echo "âš ï¸  Unpinned image: $line"
            fi
          done

  # ============================================
  # Diff Preview (PR only)
  # ============================================
  diff:
    name: Diff Preview
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flux CLI
        uses: fluxcd/flux2/action@main

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Generate diff
        run: |
          echo "## ðŸ“‹ Kustomize Build Diff" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for dir in clusters/*/; do
            CLUSTER=$(basename "$dir")
            echo "### $CLUSTER" >> $GITHUB_STEP_SUMMARY
            echo '```yaml' >> $GITHUB_STEP_SUMMARY
            kustomize build "$dir" 2>/dev/null | head -100 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          done
