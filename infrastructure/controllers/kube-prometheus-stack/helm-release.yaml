apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
spec:
  interval: 30m
  chart:
    spec:
      chart: kube-prometheus-stack
      version: "79.5.0"
      sourceRef:
        kind: HelmRepository
        name: kube-prometheus-stack
        namespace: monitoring
      interval: 12h

  install:
    crds: Create
  upgrade:
    crds: CreateReplace

  driftDetection:
    mode: enabled
    ignore:
      - paths: ["/metadata/annotation/prometheus-operator-validated"]
        target:
          kind: PrometheusRule

  values:
    alertmanager:
      config:
        global:
          resolve_timeout: 5m
        route:
          receiver: pushover
          group_by: ['alertname', 'namespace']
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 3h
          routes:
            # Silence kubeadm false positives
            - receiver: 'null'
              matchers:
                - alertname =~ "etcd.*"
            - receiver: 'null'
              matchers:
                - alertname = "KubeProxyDown"
            - receiver: 'null'
              matchers:
                - alertname =~ "KubeSchedulerDown|KubeControllerManagerDown"
            - receiver: 'null'
              matchers:
                - alertname = "Watchdog"
            - receiver: 'null'
              matchers:
                - alertname = "InfoInhibitor"
        receivers:
          - name: 'null'
          - name: pushover
            pushover_configs:
              - user_key_file: /etc/alertmanager/secrets/alertmanager-pushover/PUSHOVER_USER_KEY
                token_file: /etc/alertmanager/secrets/alertmanager-pushover/PUSHOVER_API_TOKEN
                send_resolved: true
                priority: '{{ if eq .Status "firing" }}1{{ else }}-1{{ end }}'
                title: '[{{ .Status | toUpper }}] {{ .CommonLabels.alertname }}'
                message: |-
                  {{ range .Alerts }}
                  {{ if .Annotations.description }}{{ .Annotations.description }}{{ else if .Annotations.summary }}{{ .Annotations.summary }}{{ else }}Alert: {{ .Labels.alertname }}{{ end }}
                  {{ end }}
      alertmanagerSpec:
        secrets:
          - alertmanager-pushover
    grafana:
      enabled: true
      podAnnotations:
        reloader.stakater.com/auto: "true"
      serviceAccount:
        create: true
      persistence:
        enabled: true
        type: pvc
        accessModes:
          - ReadWriteOnce
        size: 5Gi
        storageClassName: nfs
        finalizers:
          - kubernetes.io/pvc-protection
      sidecar:
        dashboards:
          enabled: true
        datasources:
          enabled: true
      admin:
        existingSecret: grafana-admin-creds
        userKey: admin-user
        passwordKey: admin-password
      ingress:
        enabled: true
        ingressClassName: traefik
        annotations:
          cert-manager.io/cluster-issuer: "letsencrypt-production"
          cert-manager.io/acme-challenge-type: "http01"
        hosts:
          - graf.heroaero.info
        tls:
          - secretName: grafana-tls
            hosts:
              - graf.heroaero.info
    additionalPrometheusRulesMap:
      blackbox-rules:
        groups:
          - name: blackbox-exporter.rules
            rules:
              - alert: BlackboxProbeFailed
                expr: probe_success == 0
                for: 1m
                labels:
                  severity: critical
                annotations:
                  summary: "Blackbox probe failed for {{ $labels.instance }}"
                  description: "Probe to {{ $labels.instance }} failed."

              - alert: BlackboxHighLatency
                expr: probe_duration_seconds > 1
                for: 2m
                labels:
                  severity: warning
                annotations:
                  summary: "Blackbox probe latency high"
                  description: "Probe to {{ $labels.instance }} is slow ({{ $value }} seconds)."

              - alert: BlackboxBadStatus
                expr: probe_http_status_code != 200
                for: 1m
                labels:
                  severity: critical
                annotations:
                  summary: "Blackbox bad HTTP status"
                  description: "Target {{ $labels.instance }} returned {{ $value }} instead of 200."
